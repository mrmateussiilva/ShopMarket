{% extends 'base.html' %}
{% load cart_filters %}

{% block title %}Meu Carrinho - {{ shop.name }}{% endblock %}

{% block content %}
<div class="container cart-page-container">
    <h1 class="section-title">Meu Carrinho</h1>

    {% if cart %}
    <div class="cart-detail-grid">
        <div class="cart-items-wrapper">
            <form method="post" action="{% url 'cart_update' %}">
                {% csrf_token %}
                <div class="cart-items-list-container">
                    {% for item in cart %}
                    <div class="cart-item-row">
                        <div class="cart-item-image-container">
                            {% if item.product.image %}
                            <img src="{{ item.product.image.url }}" alt="{{ item.name }}" class="cart-item-img-el">
                            {% elif item.product.images.first %}
                            <img src="{{ item.product.images.first.image.url }}" alt="{{ item.name }}"
                                class="cart-item-img-el">
                            {% else %}
                            <img src="https://via.placeholder.com/100x100?text=Produto" alt="{{ item.name }}"
                                class="cart-item-img-el">
                            {% endif %}
                        </div>
                        <div class="cart-item-info">
                            <h3 class="cart-item-name">{{ item.name }}</h3>
                            <div class="cart-item-code">Cod: {{ item.code }}</div>
                            <div class="cart-item-price-unit">R$ {{ item.price|format_price }}</div>
                        </div>
                    </div>
                    <div class="quantity-controls cart-item-qty">
                        <button type="button" class="btn-qty"
                            onclick="updateQtyMain('{{ item.product.id }}', -1)">-</button>
                        <input type="number" id="qty-main-{{ item.product.id }}" name="quantity_{{ item.product.id }}"
                            value="{{ item.quantity }}" min="1" max="99" class="input-qty-ajax"
                            data-product-id="{{ item.product.id }}" readonly>
                        <button type="button" class="btn-qty"
                            onclick="updateQtyMain('{{ item.product.id }}', 1)">+</button>
                    </div>
                    <div class="cart-item-total-wrapper">
                        <div id="item-total-{{ item.product.id }}" class="cart-item-total-val">R$ {{
                            item.total_price|format_price }}</div>
                        <a href="{% url 'cart_remove' item.product.id %}" class="cart-item-remove-link">Remover</a>
                    </div>
                </div>
                {% endfor %}
        </div>
    </div>

    <div class="cart-footer-actions">
        <button type="submit" class="btn-outline visible-no-js">Atualizar Quantidades</button>
        <a href="{% url 'cart_clear' %}" class="btn-clear-cart" onclick="return confirm('Limpar carrinho?')">Limpar
            Carrinho</a>
    </div>
    </form>
</div>

<div class="cart-summary-wrapper">
    <div class="cart-summary-card">
        <h3 class="summary-title">Resumo do Pedido</h3>
        {% include 'components/cart_summary.html' %}

        <a href="{% url 'checkout' %}" class="btn-buy cart-checkout-cta">Finalizar Compra</a>
        <a href="{% url 'home' %}" class="btn-continue-shopping">Continuar Comprando</a>
    </div>
</div>
</div>
{% else %}
<div class="cart-empty-state">
    <div class="empty-icon">ðŸ›’</div>
    <h2>Seu carrinho estÃ¡ vazio</h2>
    <p>Que tal dar uma olhada em nossas ofertas e escolher algo para vocÃª?</p>
    <a href="{% url 'home' %}" class="btn-buy empty-cta">Ver Ofertas</a>
</div>
{% endif %}
</div>

{% block extra_js %}
<script>
    (function () {
        // Hide native update button if JS is enabled
        const cartUpdateBtn = document.querySelector('.visible-no-js');
        if (cartUpdateBtn) cartUpdateBtn.style.display = 'none';

        // Define global functions on window to ensure accessibility
        window.updateQtyMain = function (productId, delta) {
            const input = document.getElementById(`qty-main-${productId}`);
            if (!input) return;

            let currentQty = parseInt(input.value);
            if (isNaN(currentQty)) currentQty = 1;

            let newQty = currentQty + delta;
            if (newQty < 1) return;

            input.value = newQty;

            // Sincroniza com o mini cart (flyout)
            const miniInput = document.getElementById(`qty-mini-${productId}`);
            if (miniInput) miniInput.value = newQty;

            // Chama a funÃ§Ã£o global definida no base/flyout
            if (typeof performCartUpdate === 'function') {
                performCartUpdate(productId, newQty);
            }
        };
    })();
</script>
{% endblock %}
{% endblock %}