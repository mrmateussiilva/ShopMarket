{% extends 'base.html' %}

{% block title %}Finalizar Compra - {{ shop.name }}{% endblock %}

{% block content %}
<div class="container catalog-layout">
    <h1 class="section-title">Finalizar Compra</h1>

    <div style="display: grid; grid-template-columns: 2fr 1.2fr; gap: 40px; margin-top: 30px;">
        <div class="checkout-form-wrapper">
            <form method="post" style="display: flex; flex-direction: column; gap: 30px;">
                {% csrf_token %}

                <!-- Método de Entrega -->
                <div
                    style="background: white; padding: 25px; border-radius: var(--border-radius); border: 1px solid var(--border);">
                    <h3
                        style="margin-bottom: 20px; color: var(--secondary); font-size: 1.1rem; border-bottom: 2px solid var(--bg-light); padding-bottom: 10px;">
                        1. Método de Recebimento</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <label
                            style="display: block; padding: 20px; border: 2px solid var(--bg-light); border-radius: 8px; cursor: pointer; text-align: center;">
                            <input type="radio" name="delivery_method" value="delivery" required
                                style="margin-bottom: 10px;"><br>
                            <strong>Entrega em Casa</strong>
                        </label>
                        <label
                            style="display: block; padding: 20px; border: 2px solid var(--bg-light); border-radius: 8px; cursor: pointer; text-align: center;">
                            <input type="radio" name="delivery_method" value="pickup" required
                                style="margin-bottom: 10px;"><br>
                            <strong>Retirada na Loja</strong>
                        </label>
                    </div>
                </div>

                <!-- Endereço -->
                <div
                    style="background: white; padding: 25px; border-radius: var(--border-radius); border: 1px solid var(--border);">
                    <h3
                        style="margin-bottom: 20px; color: var(--secondary); font-size: 1.1rem; border-bottom: 2px solid var(--bg-light); padding-bottom: 10px;">
                        2. Endereço de Entrega</h3>
                    <textarea name="delivery_address" rows="3"
                        placeholder="Rua, número, complemento, bairro e cidade..."
                        style="width: 100%; padding: 15px; border: 1px solid var(--border); border-radius: 4px; font-family: inherit; font-size: 1rem;"></textarea>
                </div>

                <!-- Pagamento -->
                <div
                    style="background: white; padding: 25px; border-radius: var(--border-radius); border: 1px solid var(--border);">
                    <h3
                        style="margin-bottom: 20px; color: var(--secondary); font-size: 1.1rem; border-bottom: 2px solid var(--bg-light); padding-bottom: 10px;">
                        3. Forma de Pagamento</h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 10px;">
                            O pagamento será realizado no momento da entrega ou retirada.
                        </p>
                        <label
                            style="display: flex; align-items: center; gap: 10px; padding: 15px; background: var(--bg-light); border-radius: 4px; cursor: pointer;">
                            <input type="radio" name="payment_method" value="pix" required
                                onchange="toggleChangeInput(this)">
                            <span>PIX</span>
                        </label>
                        <label
                            style="display: flex; align-items: center; gap: 10px; padding: 15px; background: var(--bg-light); border-radius: 4px; cursor: pointer;">
                            <input type="radio" name="payment_method" value="card" required
                                onchange="toggleChangeInput(this)">
                            <span>Cartão (Levar maquininha)</span>
                        </label>
                        <label
                            style="display: flex; align-items: center; gap: 10px; padding: 15px; background: var(--bg-light); border-radius: 4px; cursor: pointer;">
                            <input type="radio" name="payment_method" value="money" required
                                onchange="toggleChangeInput(this)">
                            <span>Dinheiro</span>
                        </label>

                        <div id="change-input-wrapper"
                            style="display: none; margin-top: 10px; padding: 15px; border: 1px dashed var(--secondary); border-radius: 4px; background: #fff;">
                            <label for="cash_change"
                                style="display: block; margin-bottom: 5px; font-weight: bold; color: var(--secondary);">
                                Precisa de troco para quanto?
                            </label>
                            <input type="text" name="cash_change" id="cash_change" placeholder="Ex: 50.00"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px;">
                            <small style="display: block; margin-top: 5px; color: var(--text-muted);">
                                O valor deve ser maior que o total do pedido.
                            </small>
                        </div>
                    </div>
                </div>

                <div
                    style="background: white; padding: 25px; border-radius: var(--border-radius); border: 1px solid var(--border);">
                    <h3
                        style="margin-bottom: 20px; color: var(--secondary); font-size: 1.1rem; border-bottom: 2px solid var(--bg-light); padding-bottom: 10px;">
                        4. Observações</h3>
                    <textarea name="delivery_notes" rows="2"
                        placeholder="Algum detalhe para nosso entregador? (Opcional)"
                        style="width: 100%; padding: 15px; border: 1px solid var(--border); border-radius: 4px; font-family: inherit; font-size: 1rem;"></textarea>
                </div>

                <button type="submit" class="btn-buy" style="padding: 20px; font-size: 1.3rem;">Confirmar e Finalizar
                    Pedido</button>
            </form>
        </div>

        <div class="checkout-summary-wrapper" style="position: sticky; top: 120px;">
            <div
                style="background: white; padding: 25px; border-radius: var(--border-radius); border: 1px solid var(--border);">
                <h3 style="margin-bottom: 20px; color: var(--secondary);">Resumo da Compra</h3>
                {% include 'components/cart_summary.html' %}

                <div
                    style="margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border); font-size: 0.85rem; color: var(--text-muted);">
                    Ao clicar em finalizar, você concorda com nossos termos de venda e política de privacidade.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function toggleChangeInput(radio) {
        const changeWrapper = document.getElementById('change-input-wrapper');
        const changeInput = document.getElementById('cash_change');

        if (radio.value === 'money') {
            changeWrapper.style.display = 'block';
            changeInput.required = true;
            // Focus on input
            setTimeout(() => {
                changeInput.focus();
            }, 100);
        } else {
            changeWrapper.style.display = 'none';
            changeInput.required = false;
            changeInput.value = '';
        }
    }

    // Run on load to handle back button or prepopulated state
    document.addEventListener('DOMContentLoaded', function () {
        const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
        if (selectedPayment) {
            toggleChangeInput(selectedPayment);
        }

        // Simple mask for currency
        const changeInput = document.getElementById('cash_change');
        if (changeInput) {
            changeInput.addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, '');
                value = (value / 100).toFixed(2) + '';
                value = value.replace(".", ",");
                value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
                e.target.value = value;
            });
        }
    });
</script>
{% endblock %}