<div id="cart-flyout" class="cart-flyout">
    <div class="cart-flyout-overlay" onclick="toggleCart()"></div>
    <div class="cart-flyout-content">
        <div class="cart-flyout-header">
            <h3>ðŸ›’ Meu Carrinho</h3>
            <button class="btn-close-cart" onclick="toggleCart()">âœ•</button>
        </div>

        <div id="cart-flyout-inner">
            {% include 'partials/cart_flyout_content.html' %}
        </div>
    </div>
</div>

<script>
    function toggleCart() {
        const flyout = document.getElementById('cart-flyout');
        if (flyout) {
            flyout.classList.toggle('active');
            document.body.classList.toggle('no-scroll');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function updateQtyMini(productId, delta) {
        const input = document.getElementById(`qty-mini-${productId}`);
        if (!input) return;

        let currentQty = parseInt(input.value);
        if (isNaN(currentQty)) currentQty = 1;

        let newQty = currentQty + delta;
        if (newQty < 1) return;

        input.value = newQty;

        // Sincroniza com a pÃ¡gina de detalhes (se estiver nela)
        const cartPageInput = document.querySelector(`.input-qty-ajax[data-product-id="${productId}"]`);
        if (cartPageInput) {
            cartPageInput.value = newQty;
        }

        performCartUpdate(productId, newQty);
    }

    function performCartUpdate(productId, quantity) {
        if (isNaN(parseInt(quantity))) {
            console.error('Invalid quantity:', quantity);
            return;
        }
        const csrftoken = getCookie('csrftoken');
        const formData = new FormData();
        formData.append('product_id', productId);
        formData.append('quantity', quantity);

        fetch('{% url "cart_update_ajax" %}', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Atualiza Flyout
                    const miniTotal = document.getElementById(`mini-item-total-${productId}`);
                    if (miniTotal) miniTotal.innerText = `R$ ${data.item_total}`;

                    // Atualiza PÃ¡gina de Carrinho
                    const pageTotal = document.getElementById(`item-total-${productId}`);
                    if (pageTotal) pageTotal.innerText = `R$ ${data.item_total}`;

                    // Atualiza Totais Globais
                    document.querySelectorAll('.cart-total-value').forEach(el => {
                        el.innerText = `R$ ${data.cart_total}`;
                    });

                    // Atualiza total no header
                    const headerTotal = document.querySelector('.cart-total');
                    if (headerTotal) {
                        headerTotal.innerText = `R$ ${data.cart_total}`;
                    }

                    // Contagem no header
                    document.querySelectorAll('.cart-count').forEach(el => {
                        el.innerText = data.cart_count;
                    });

                    // Contagem no resumo do carrinho
                    document.querySelectorAll('.cart-summary-count').forEach(el => {
                        el.innerText = data.cart_count;
                    });
                }
            })
            .catch(error => console.error('Error updating cart:', error));
    }
</script>