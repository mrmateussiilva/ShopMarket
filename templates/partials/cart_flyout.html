<div id="cart-flyout" class="cart-flyout">
    <div class="cart-flyout-overlay" onclick="toggleCart()"></div>
    <div class="cart-flyout-content">
        <div class="cart-flyout-header">
            <h3>üõí Meu Carrinho</h3>
            <button class="btn-close-cart" onclick="toggleCart()">‚úï</button>
        </div>

        <div class="cart-flyout-body">
            {% if cart %}
            <div class="cart-items-list">
                {% for item in cart %}
                {% with product=item.product %}
                <div class="cart-item">
                    <div class="cart-item-img">
                        {% if product.images.first %}
                        <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}">
                        {% else %}
                        <img src="https://via.placeholder.com/60x60?text={{ product.name|urlencode }}"
                            alt="{{ product.name }}">
                        {% endif %}
                    </div>
                    <div class="cart-item-details">
                        <h4 class="cart-item-name">{{ product.name }}</h4>
                        <div class="cart-item-price-qty">
                            <div class="quantity-controls miniature">
                                <button type="button" class="btn-qty"
                                    onclick="updateQtyMini('{{ product.id }}', -1)">-</button>
                                <input type="number" id="qty-mini-{{ product.id }}" value="{{ item.quantity }}" readonly
                                    class="input-qty-mini">
                                <button type="button" class="btn-qty"
                                    onclick="updateQtyMini('{{ product.id }}', 1)">+</button>
                            </div>
                            <strong id="mini-item-total-{{ product.id }}">R$ {{ item.total_price }}</strong>
                        </div>
                    </div>
                    <a href="{% url 'cart_remove' product.id %}" class="btn-remove-item" title="Remover">üóëÔ∏è</a>
                </div>
                {% endwith %}
                {% endfor %}
            </div>
            {% else %}
            <div class="cart-empty">
                <span class="icon">üõí</span>
                <p>Seu carrinho est√° vazio</p>
                <button class="btn-buy" onclick="toggleCart()">Come√ßar a comprar</button>
            </div>
            {% endif %}
        </div>

        {% if cart %}
        <div class="cart-flyout-footer">
            <div class="cart-summary">
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span class="cart-total-value">R$ {{ cart.get_total_price }}</span>
                </div>
                <!-- Delivery info or discounts could go here -->
                <div class="summary-row total">
                    <span>Total</span>
                    <strong class="cart-total-value">R$ {{ cart.get_total_price }}</strong>
                </div>
            </div>
            <div class="cart-actions">
                <a href="{% url 'cart_detail' %}" class="btn-view-cart">Ver Carrinho</a>
                <a href="{% url 'checkout' %}" class="btn-checkout">Finalizar Compra</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function toggleCart() {
        const flyout = document.getElementById('cart-flyout');
        if (flyout) {
            flyout.classList.toggle('active');
            document.body.classList.toggle('no-scroll');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function updateQtyMini(productId, delta) {
        const input = document.getElementById(`qty-mini-${productId}`);
        if (!input) return;

        let newQty = parseInt(input.value) + delta;
        if (newQty < 1) return;

        input.value = newQty;

        // Sincroniza com a p√°gina de detalhes (se estiver nela)
        const cartPageInput = document.querySelector(`.input-qty-ajax[data-product-id="${productId}"]`);
        if (cartPageInput) {
            cartPageInput.value = newQty;
        }

        performCartUpdate(productId, newQty);
    }

    function performCartUpdate(productId, quantity) {
        const csrftoken = getCookie('csrftoken');
        const formData = new FormData();
        formData.append('product_id', productId);
        formData.append('quantity', quantity);

        fetch('{% url "cart_update_ajax" %}', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Atualiza Flyout
                    const miniTotal = document.getElementById(`mini-item-total-${productId}`);
                    if (miniTotal) miniTotal.innerText = `R$ ${data.item_total}`;

                    // Atualiza P√°gina de Carrinho
                    const pageTotal = document.getElementById(`item-total-${productId}`);
                    if (pageTotal) pageTotal.innerText = `R$ ${data.item_total}`;

                    // Atualiza Totais Globais
                    document.querySelectorAll('.cart-total-value').forEach(el => {
                        el.innerText = `R$ ${data.cart_total}`;
                    });

                    // Atualiza total no header
                    const headerTotal = document.querySelector('.cart-total');
                    if (headerTotal) {
                        headerTotal.innerText = `R$ ${data.cart_total}`;
                    }

                    // Contagem no header
                    document.querySelectorAll('.cart-count').forEach(el => {
                        el.innerText = data.cart_count;
                    });

                    // Contagem no resumo do carrinho
                    document.querySelectorAll('.cart-summary-count').forEach(el => {
                        el.innerText = data.cart_count;
                    });
                }
            })
            .catch(error => console.error('Error updating cart:', error));
    }
</script>
