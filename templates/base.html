{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ShopMarket{% endblock %}</title>
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link rel="stylesheet" href="{% static 'css/theme.css' %}?v=2.0">
    {% block extra_css %}{% endblock %}
</head>

<body>
    <form id="csrf-token-form" method="post" style="display: none;">
        {% csrf_token %}
    </form>
    {% include 'partials/header.html' %}
    {% include 'partials/cart_flyout.html' %}

    <main id="main-content">
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="message {{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% block content %}
        {% endblock %}
    </main>

    {% include 'partials/footer.html' %}
    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        function updateHeaderCart(count, total) {
            const cartIcon = document.querySelector('.cart-icon-container');
            if (cartIcon) {
                let countEl = cartIcon.querySelector('.cart-count');
                if (!countEl) {
                    countEl = document.createElement('span');
                    countEl.className = 'cart-count';
                    cartIcon.appendChild(countEl);
                }
                countEl.innerText = count;
            }
            const headerTotal = document.querySelector('.cart-total');
            if (headerTotal) {
                headerTotal.innerText = `R$ ${total}`;
            }
        }

        function showToast(message, type = 'success') {
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <div class="toast-icon">
                    <span>${type === 'success' ? '✅' : 'ℹ️'}</span>
                </div>
                <div class="toast-message">${message}</div>
            `;

            container.appendChild(toast);

            // Trigger reflow
            toast.offsetHeight;

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        function bindAddToCartForms() {
            const forms = document.querySelectorAll('form.add-to-cart-form, form.pdp-actions-form');
            forms.forEach(form => {
                if (form.dataset.ajaxBound === 'true') return;
                form.dataset.ajaxBound = 'true';
                form.addEventListener('submit', event => {
                    event.preventDefault();
                    const formData = new FormData(form);
                    const csrfToken = formData.get('csrfmiddlewaretoken');
                    fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfToken,
                        },
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (!data.success) return;

                            // Show Notification
                            const productName = data.product_name ? `${data.product_name} ` : '';
                            showToast(`${productName}adicionado ao carrinho!`);

                            updateHeaderCart(data.cart_count, data.cart_total);
                            const flyoutInner = document.getElementById('cart-flyout-inner');
                            if (flyoutInner && data.flyout_html) {
                                flyoutInner.innerHTML = data.flyout_html;
                            }
                            const submitButton = form.querySelector('button[type="submit"]');
                            if (submitButton) {
                                submitButton.classList.add('btn-added');
                                setTimeout(() => submitButton.classList.remove('btn-added'), 800);
                            }
                            document.querySelectorAll('.cart-total-value').forEach(el => {
                                el.innerText = `R$ ${data.cart_total}`;
                            });
                            document.querySelectorAll('.cart-count').forEach(el => {
                                el.innerText = data.cart_count;
                            });
                            document.querySelectorAll('.cart-summary-count').forEach(el => {
                                el.innerText = data.cart_count;
                            });
                        })
                        .catch(error => console.error('Error adding to cart:', error));
                });
            });
        }

        document.addEventListener('DOMContentLoaded', bindAddToCartForms);
    </script>
    {% block extra_js %}{% endblock %}
</body>

</html>
